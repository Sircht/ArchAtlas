<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArchAtlas</title>

  <!-- Manifesto PWA e ícones -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <style>
    :root {
      color-scheme: dark;
      --panel-bg: rgba(12, 12, 12, 0.82);
      --panel-border: rgba(255, 255, 255, 0.08);
      --accent: #0aa9ff;
      --accent-strong: #2cc1ff;
      --text-muted: #9aa0a6;
      --error: #ff6464;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", "Inter", Arial, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(25, 25, 25, 0.95), #060606);
      color: #fff;
      overflow: hidden;
    }

    #map {
      width: 100vw;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    .toolbar {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 14px;
      max-width: min(420px, calc(100vw - 32px));
      box-shadow: 0 18px 44px rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
      pointer-events: auto;
    }

    .toolbar h1 {
      margin: 0 0 4px;
      font-size: 18px;
      font-weight: 600;
      flex-basis: 100%;
      color: #fff;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .toolbar small {
      flex-basis: 100%;
      margin: -2px 0 6px;
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: 0.03em;
    }

    .btn {
      padding: 9px 14px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      background: rgba(25, 25, 25, 0.85);
      color: #f0f4ff;
      transition: background 0.18s ease, border-color 0.18s ease, transform 0.18s ease,
        box-shadow 0.18s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 40px;
    }

    .btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .btn:hover,
    .btn:focus-visible {
      background: rgba(40, 40, 40, 0.92);
      border-color: rgba(255, 255, 255, 0.18);
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.35);
      outline: none;
    }

    .btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: rgba(255, 255, 255, 0.24);
      color: #021b2a;
      font-weight: 600;
    }

    gmp-place-autocomplete {
      flex: 1;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 14px;
      background: rgba(20, 20, 20, 0.85);
      color: #fff;
      pointer-events: auto;
      outline: none;
    }

    gmp-place-autocomplete::part(input) {
      color: inherit;
    }

    gmp-place-autocomplete::part(input)::placeholder {
      color: var(--text-muted);
    }

    .status-panel {
      position: absolute;
      right: 16px;
      bottom: 16px;
      max-width: 280px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 14px 18px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      font-size: 13px;
      line-height: 1.6;
      pointer-events: none;
    }

    .status-panel strong {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #fff;
      letter-spacing: 0.04em;
    }

    .status-panel span {
      display: block;
      color: var(--text-muted);
    }

    .status-panel .highlight {
      color: var(--accent-strong);
      font-weight: 600;
    }

    .toast {
      position: absolute;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 18px;
      border-radius: 24px;
      background: rgba(30, 30, 30, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #fff;
      font-size: 14px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }

    .toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast.error {
      background: rgba(110, 16, 16, 0.92);
      border-color: rgba(255, 120, 120, 0.4);
    }

    @media (max-width: 1024px) {
      .toolbar {
        max-width: min(480px, calc(100vw - 32px));
      }
    }

    @media (max-width: 720px) {
      body {
        overflow: auto;
      }

      #map {
        height: 100dvh;
      }

      .toolbar {
        position: fixed;
        inset: auto 16px 16px 16px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
      }

      .toolbar h1,
      .toolbar small {
        text-align: center;
      }

      .btn,
      gmp-place-autocomplete {
        width: 100%;
        justify-content: center;
      }

      .status-panel {
        position: static;
        max-width: none;
        margin: 16px;
      }

      .toast {
        bottom: 120px;
      }
    }
  </style>
</head>

<body>
  <div id="map" aria-label="Mapa do ArchAtlas"></div>

  <div class="toolbar" role="group" aria-label="Ferramentas do ArchAtlas">
    <h1>ArchAtlas</h1>
    <small>Explore, busque lugares e exporte camadas urbanas</small>
    <gmp-place-autocomplete
      id="autocomplete"
      placeholder="Buscar endereço ou lugar..."
      aria-label="Pesquisar endereço ou lugar">
    </gmp-place-autocomplete>

    <button class="btn active" data-map="f06444fc1b6b5f66ec5f8299">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2 3 6v12l9 4 9-4V6zm7 5.97-6 2.66v8.34l6-2.67zm-8 11-6-2.67V8.63l6 2.66z"/></svg>
      Mapa Base
    </button>
    <button class="btn" data-map="f06444fc1b6b5f669fa1e951">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18v2H3zm0 6h12v2H3zm0 6h18v2H3z"/></svg>
      Cheios e Vazios
    </button>
    <button class="btn" id="locateMe">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m12 2 4 9-4 11-4-11zm0 5.3L10.74 9h2.52z"/></svg>
      Minha localização
    </button>
    <button class="btn" id="exportPNG">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 3h14a2 2 0 0 1 2 2v9h-2V5H5v14h7v2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm11 10 4 4-4 4v-3h-5v-2h5z"/></svg>
      Exportar PNG
    </button>
    <button class="btn" id="exportDWG">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 4h16v2H4zm0 4h16v2H4zm0 4h10v2H4zm0 4h6v2H4z"/></svg>
      Exportar DWG Real
    </button>
  </div>

  <aside class="status-panel" aria-live="polite">
    <strong>Status do mapa</strong>
    <span id="statusMapStyle">Estilo: <span class="highlight">Mapa Base</span></span>
    <span id="statusCoordinates">Centro: lat -22.370800, lng -41.786900</span>
    <span id="statusSelection">Nenhum lugar selecionado</span>
  </aside>

  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <script>
    const MAP_STYLES = {
      "f06444fc1b6b5f66ec5f8299": "Mapa Base",
      "f06444fc1b6b5f669fa1e951": "Cheios e Vazios"
    };

    const DEFAULT_VIEW = {
      center: { lat: -22.3708, lng: -41.7869 },
      zoom: 17,
      heading: 0,
      tilt: 0
    };

    let map;
    let placeMarker = null;
    let currentMapId = "f06444fc1b6b5f66ec5f8299";
    let lastSelectionMarkup = "Nenhum lugar selecionado";

    const statusMapStyle = document.getElementById("statusMapStyle");
    const statusCoordinates = document.getElementById("statusCoordinates");
    const statusSelection = document.getElementById("statusSelection");
    const toastElement = document.getElementById("toast");

    function updateStatusPanel(selectionMarkup) {
      if (!map) {
        return;
      }

      if (selectionMarkup) {
        lastSelectionMarkup = selectionMarkup;
      }

      const center = map.getCenter();
      const lat = center?.lat?.() ?? DEFAULT_VIEW.center.lat;
      const lng = center?.lng?.() ?? DEFAULT_VIEW.center.lng;

      statusMapStyle.innerHTML = `Estilo: <span class="highlight">${
        MAP_STYLES[currentMapId] ?? "Mapa personalizado"
      }</span>`;
      statusCoordinates.textContent = `Centro: lat ${lat.toFixed(6)}, lng ${lng.toFixed(6)}`;
      statusSelection.innerHTML = lastSelectionMarkup;
    }

    function showToast(message, type = "info") {
      toastElement.textContent = message;
      toastElement.classList.toggle("error", type === "error");
      toastElement.classList.add("visible");

      window.clearTimeout(showToast.timeoutId);
      showToast.timeoutId = window.setTimeout(() => {
        toastElement.classList.remove("visible");
        toastElement.classList.remove("error");
      }, 3200);
    }

    function triggerDownload(url, filename) {
      const link = document.createElement("a");
      link.href = url;
      link.rel = "noopener";
      if (filename) {
        link.download = filename;
      }

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function resolvePlaceDescription(placeLike) {
      if (!placeLike) return "Local selecionado";
      const displayName = placeLike.displayName;
      if (typeof displayName === "string") {
        return displayName;
      }
      if (displayName?.text) {
        return displayName.text;
      }
      return (
        placeLike.formattedAddress ||
        placeLike.formatted_address ||
        placeLike.name ||
        placeLike.description ||
        "Local selecionado"
      );
    }

    function handlePlaceSelection({ location, description }) {
      if (!map || !location) {
        showToast("Não foi possível obter a localização do lugar selecionado.", "error");
        return;
      }

      const latLng =
        location instanceof google.maps.LatLng
          ? location
          : new google.maps.LatLng(location);

      if (!placeMarker) {
        placeMarker = new google.maps.marker.AdvancedMarkerElement({
          position: latLng,
          map,
          title: description
        });
      } else {
        placeMarker.position = latLng;
        placeMarker.title = description;
      }

      if (typeof map.panTo === "function") {
        map.panTo(latLng);
      }

      const currentZoom = typeof map.getZoom === "function" ? map.getZoom() : DEFAULT_VIEW.zoom;
      if (typeof map.setZoom === "function") {
        map.setZoom(Math.max(currentZoom ?? DEFAULT_VIEW.zoom, 17));
      }

      updateStatusPanel(`<span class="highlight">${description}</span>`);
    }

    function setActiveMapButton(mapId) {
      document.querySelectorAll(".btn[data-map]").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.map === mapId);
      });
    }

    function normalizeCenter(center) {
      if (!center) {
        return DEFAULT_VIEW.center;
      }

      if (typeof center.lat === "function" && typeof center.lng === "function") {
        return center;
      }

      const lat = typeof center.lat === "function" ? center.lat() : center.lat;
      const lng = typeof center.lng === "function" ? center.lng() : center.lng;

      if (typeof lat === "number" && typeof lng === "number") {
        return { lat, lng };
      }

      return DEFAULT_VIEW.center;
    }

    function createMapInstance(mapId, viewOverrides = {}) {
      const mapElement = document.getElementById("map");
      if (!mapElement) {
        return null;
      }

      const previousMap = map;
      const center = normalizeCenter(
        viewOverrides.center ?? previousMap?.getCenter?.() ?? DEFAULT_VIEW.center
      );

      const zoom = viewOverrides.zoom ?? previousMap?.getZoom?.() ?? DEFAULT_VIEW.zoom;
      const heading = viewOverrides.heading ?? previousMap?.getHeading?.() ?? DEFAULT_VIEW.heading;
      const tilt = viewOverrides.tilt ?? previousMap?.getTilt?.() ?? DEFAULT_VIEW.tilt;

      map = new google.maps.Map(mapElement, {
        ...DEFAULT_VIEW,
        center,
        zoom,
        heading,
        tilt,
        mapId,
        disableDefaultUI: false,
        gestureHandling: "greedy"
      });

      map.addListener("idle", () => updateStatusPanel());
      updateStatusPanel();

      if (placeMarker) {
        placeMarker.map = map;
      }

      return map;
    }

    function switchMapStyle(mapId) {
      if (!map || mapId === currentMapId) {
        return;
      }

      currentMapId = mapId;
      createMapInstance(mapId);
      setActiveMapButton(mapId);
      updateStatusPanel();
      showToast(`Estilo alterado para ${MAP_STYLES[mapId] ?? "mapa personalizado"}.`);
    }

    function initMap() {
      createMapInstance(currentMapId, DEFAULT_VIEW);
      setActiveMapButton(currentMapId);

      document.querySelectorAll(".btn[data-map]").forEach((btn) => {
        btn.addEventListener("click", () => switchMapStyle(btn.dataset.map));
      });

      const autocomplete = document.getElementById("autocomplete");
      autocomplete.addEventListener("gmp-placeselect", async (event) => {
        const detail = event.detail ?? {};
        const place = detail.place || detail.placeResult;

        if (!place) {
          showToast("Não foi possível completar a busca.", "error");
          return;
        }

        try {
          if (typeof place.fetchFields === "function") {
            await place.fetchFields({
              fields: ["displayName", "formattedAddress", "geometry", "location", "name"]
            });
          }

          const location =
            place.geometry?.location || detail.location || place.location || null;

          handlePlaceSelection({
            location,
            description: resolvePlaceDescription(place)
          });
        } catch (error) {
          console.error(error);
          showToast("Não foi possível obter detalhes do lugar selecionado.", "error");
        }
      });

      document.getElementById("locateMe").addEventListener("click", () => {
        if (!navigator.geolocation) {
          showToast("Geolocalização não suportada neste dispositivo.", "error");
          return;
        }

        showToast("Localizando você no mapa...");
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            const location = { lat: latitude, lng: longitude };

            handlePlaceSelection({
              location,
              description: "Minha localização"
            });
          },
          () => {
            showToast("Não foi possível acessar sua localização.", "error");
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 1000 }
        );
      });

      document.getElementById("exportPNG").addEventListener("click", async () => {
        if (!map) {
          showToast("Mapa ainda não foi carregado.", "error");
          return;
        }

        const center = map.getCenter();
        if (!center) {
          showToast("Não foi possível calcular o centro do mapa.", "error");
          return;
        }

        const zoom = Math.round(map.getZoom?.() ?? DEFAULT_VIEW.zoom);
        const scale = window.devicePixelRatio > 1 ? 2 : 1;
        const mapElementSize = document.getElementById("map");
        const width = Math.max(
          200,
          Math.min(640, Math.round(mapElementSize.offsetWidth || 640))
        );
        const height = Math.max(
          200,
          Math.min(640, Math.round(mapElementSize.offsetHeight || 360))
        );

        showToast("Gerando exportação PNG...");

        const params = new URLSearchParams({
          center: `${center.lat()},${center.lng()}`,
          zoom: String(zoom),
          scale: String(scale),
          width: String(width),
          height: String(height)
        });

        if (currentMapId) {
          params.append("mapId", currentMapId);
        }

        const downloadUrl = `/export-png?${params.toString()}`;
        const filename = `archatlas_${Date.now()}.png`;

        try {
          const response = await fetch(downloadUrl);
          if (!response.ok) {
            throw new Error("Falha ao gerar imagem");
          }

          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          triggerDownload(blobUrl, filename);
          window.setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);

          showToast("Exportação em PNG concluída.");
        } catch (error) {
          console.error(error);
          triggerDownload(downloadUrl, filename);
          showToast(
            "Não foi possível gerar o PNG automaticamente. Abrimos o mapa em nova guia.",
            "info"
          );
        }
      });

      document.getElementById("exportDWG").addEventListener("click", async () => {
        if (!map) {
          showToast("Mapa ainda não foi carregado.", "error");
          return;
        }

        const bounds = map.getBounds?.();
        if (!bounds) {
          showToast("Não foi possível determinar a área do mapa.", "error");
          return;
        }

        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const params = new URLSearchParams({
          north: String(ne.lat()),
          east: String(ne.lng()),
          south: String(sw.lat()),
          west: String(sw.lng())
        });

        showToast("Gerando exportação DWG...");

        try {
          const response = await fetch(`/export-dwg?${params.toString()}`);
          if (!response.ok) {
            throw new Error("Falha ao gerar DWG");
          }

          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          triggerDownload(blobUrl, `archatlas_${Date.now()}.dxf`);
          window.setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);

          showToast("Exportação DWG concluída.");
        } catch (error) {
          console.error(error);
          showToast("Não foi possível exportar o mapa em DWG.", "error");
        }
      });
    }

    window.initMap = initMap;

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/service-worker.js").catch(() => {
          console.warn("Não foi possível registrar o service worker.");
        });
      });
    }
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOJb2_2hPShr2KC7AJaFFUZvKrKdvAZmI&libraries=places,marker&callback=initMap&v=weekly"
    async
    defer>
  </script>

</body>
</html>
