<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArchAtlas</title>

  <!-- Manifesto PWA e ícones -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <style>
    :root {
      color-scheme: dark;
      --panel-bg: rgba(12, 12, 12, 0.85);
      --accent: #0099ff;
      --text-muted: #9aa0a6;
      --error: #ff6464;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: #0b0b0b;
      color: #fff;
      overflow: hidden;
    }

    #map {
      width: 100vw;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    .toolbar {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(6px);
      z-index: 9999;
      pointer-events: auto;
    }

    .toolbar h1 {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
      flex-basis: 100%;
      color: #fff;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .btn {
      padding: 8px 12px;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      background: #1c1c1c;
      color: #fff;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .btn:hover {
      background: #2f2f2f;
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .btn.active {
      background: var(--accent);
      border-color: rgba(255, 255, 255, 0.25);
      color: #001320;
      font-weight: 600;
    }

    gmp-place-autocomplete {
      width: 260px;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 14px;
      background: #1c1c1c;
      color: #fff;
      pointer-events: auto;
      outline: none;
    }

    ::placeholder {
      color: var(--text-muted);
    }

    .status-panel {
      position: absolute;
      right: 16px;
      bottom: 16px;
      max-width: 260px;
      background: var(--panel-bg);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(6px);
      font-size: 13px;
      line-height: 1.6;
      pointer-events: none;
    }

    .status-panel strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #fff;
      letter-spacing: 0.03em;
    }

    .status-panel span {
      display: block;
      color: var(--text-muted);
    }

    .status-panel .highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .toast {
      position: absolute;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%) translateY(20px);
      padding: 10px 16px;
      border-radius: 20px;
      background: rgba(30, 30, 30, 0.95);
      color: #fff;
      font-size: 14px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.visible {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .toast svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .toast.error {
      background: rgba(80, 0, 0, 0.9);
    }

    @media (max-width: 720px) {
      .toolbar {
        right: 16px;
        left: 16px;
        top: auto;
        bottom: 16px;
        justify-content: center;
      }

      .toolbar h1 {
        text-align: center;
      }

      .status-panel {
        position: static;
        max-width: none;
        margin: 16px;
      }
    }
  </style>
</head>

<body>
  <div id="map" aria-label="Mapa do ArchAtlas"></div>

  <div class="toolbar" role="group" aria-label="Ferramentas do ArchAtlas">
    <h1>ArchAtlas</h1>
    <gmp-place-autocomplete
      id="autocomplete"
      placeholder="Buscar endereço ou lugar..."
      aria-label="Pesquisar endereço ou lugar">
    </gmp-place-autocomplete>

    <button class="btn active" data-map="f06444fc1b6b5f66ec5f8299">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2 3 6v12l9 4 9-4V6zm7 5.97-6 2.66v8.34l6-2.67zm-8 11-6-2.67V8.63l6 2.66z"/></svg>
      Mapa Base
    </button>
    <button class="btn" data-map="f06444fc1b6b5f669fa1e951">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18v2H3zm0 6h12v2H3zm0 6h18v2H3z"/></svg>
      Cheios e Vazios
    </button>
    <button class="btn" id="locateMe">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m12 2 4 9-4 11-4-11zm0 5.3L10.74 9h2.52z"/></svg>
      Minha localização
    </button>
    <button class="btn" id="exportPNG">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 3h14a2 2 0 0 1 2 2v9h-2V5H5v14h7v2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm11 10 4 4-4 4v-3h-5v-2h5z"/></svg>
      Exportar PNG
    </button>
    <button class="btn" id="exportDWG">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 4h16v2H4zm0 4h16v2H4zm0 4h10v2H4zm0 4h6v2H4z"/></svg>
      Exportar DWG Real
    </button>
  </div>

  <aside class="status-panel" aria-live="polite">
    <strong>Status do mapa</strong>
    <span id="statusMapStyle">Estilo: <span class="highlight">Mapa Base</span></span>
    <span id="statusCoordinates">Centro: lat -22.370800, lng -41.786900</span>
    <span id="statusSelection">Nenhum lugar selecionado</span>
  </aside>

  <div class="toast" id="toast" role="alert" aria-live="assertive"></div>

  <script>
    const MAP_STYLES = {
      "f06444fc1b6b5f66ec5f8299": "Mapa Base",
      "f06444fc1b6b5f669fa1e951": "Cheios e Vazios"
    };

    let map;
    let placeMarker = null;
    let currentMapId = "f06444fc1b6b5f66ec5f8299";
    const statusMapStyle = document.getElementById("statusMapStyle");
    const statusCoordinates = document.getElementById("statusCoordinates");
    const statusSelection = document.getElementById("statusSelection");
    const toastElement = document.getElementById("toast");

    const defaultCenter = { lat: -22.3708, lng: -41.7869 };

    function createMap(mapId, viewState = {}) {
      const mapContainer = document.getElementById("map");
      const {
        center = defaultCenter,
        zoom = 17,
        heading = 0,
        tilt = 0
      } = viewState;

      map = new google.maps.Map(mapContainer, {
        center,
        zoom,
        heading,
        tilt,
        mapId,
        disableDefaultUI: false
      });

      currentMapId = mapId;

      map.addListener("idle", () => updateStatusPanel());

      if (placeMarker) {
        placeMarker.map = map;
      }

      updateStatusPanel();
    }

    function updateStatusPanel(selectionText) {
      if (!map) return;
      const center = map.getCenter();
      const lat = center.lat().toFixed(6);
      const lng = center.lng().toFixed(6);
      statusMapStyle.innerHTML = `Estilo: <span class="highlight">${MAP_STYLES[currentMapId] ?? "Mapa personalizado"}</span>`;
      statusCoordinates.textContent = `Centro: lat ${lat}, lng ${lng}`;
      if (selectionText) {
        statusSelection.innerHTML = selectionText;
      }
    }

    function showToast(message, type = "info") {
      toastElement.textContent = message;
      toastElement.classList.toggle("error", type === "error");
      toastElement.classList.add("visible");

      window.clearTimeout(showToast.timeoutId);
      showToast.timeoutId = window.setTimeout(() => {
        toastElement.classList.remove("visible");
        toastElement.classList.remove("error");
      }, 3200);
    }

    function triggerDownload(url, filename) {
      const link = document.createElement("a");
      link.href = url;
      link.rel = "noopener";
      if (filename) {
        link.download = filename;
      }

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function handlePlaceSelection({ location, description }) {
      if (!location) {
        showToast("Não foi possível obter a localização do lugar selecionado.", "error");
        return;
      }

      const latLng =
        location instanceof google.maps.LatLng
          ? location
          : new google.maps.LatLng(location);

      if (!placeMarker) {
        placeMarker = new google.maps.marker.AdvancedMarkerElement({
          position: latLng,
          map,
          title: description
        });
      } else {
        placeMarker.position = latLng;
        placeMarker.title = description;
      }

      map.panTo(latLng);
      map.setZoom(Math.max(map.getZoom(), 17));

      updateStatusPanel(`<span class="highlight">${description}</span>`);
    }

    function resolvePlaceDescription(placeLike) {
      if (!placeLike) return "Local selecionado";
      const displayName = placeLike.displayName;
      if (typeof displayName === "string") {
        return displayName;
      }
      if (displayName?.text) {
        return displayName.text;
      }
      return (
        placeLike.formattedAddress ||
        placeLike.formatted_address ||
        placeLike.name ||
        placeLike.description ||
        "Local selecionado"
      );
    }

    function initMap() {
      createMap(currentMapId);

      const buttons = document.querySelectorAll(".btn[data-map]");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (!map || btn.classList.contains("active")) return;
          const id = btn.dataset.map;
          const viewState = {
            center: map.getCenter(),
            zoom: map.getZoom(),
            heading: map.getHeading?.() ?? 0,
            tilt: map.getTilt?.() ?? 0
          };

          if (typeof map.setOptions === "function") {
            map.setOptions({ mapId: id });
            currentMapId = id;
            updateStatusPanel();
          } else {
            createMap(id, viewState);
          }

          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          showToast(`Estilo alterado para ${MAP_STYLES[id] ?? "mapa personalizado"}.`);
        });
      });

      const autocomplete = document.querySelector("#autocomplete");
      autocomplete.addEventListener("gmp-placeselect", async (event) => {
        const detail = event.detail || {};
        const place = detail.place || detail.placeResult;

        if (!place) {
          showToast("Não foi possível completar a busca.", "error");
          return;
        }

        try {
          if (typeof place.fetchFields === "function") {
            await place.fetchFields({
              fields: ["displayName", "formattedAddress", "geometry", "location", "name"]
            });
          }

          const location =
            place.geometry?.location || place.location || detail?.location || null;

          handlePlaceSelection({
            location,
            description: resolvePlaceDescription(place)
          });
        } catch (error) {
          console.error(error);
          showToast("Não foi possível obter detalhes do lugar selecionado.", "error");
        }
      });

      document.getElementById("locateMe").addEventListener("click", () => {
        if (!navigator.geolocation) {
          showToast("Geolocalização não suportada neste dispositivo.", "error");
          return;
        }

        showToast("Localizando você no mapa...");
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            const location = { lat: latitude, lng: longitude };
            map.panTo(location);
            map.setZoom(Math.max(map.getZoom(), 17));

            if (!placeMarker) {
              placeMarker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map,
                title: "Minha localização"
              });
            } else {
              placeMarker.position = location;
              placeMarker.title = "Minha localização";
            }

            updateStatusPanel('<span class="highlight">Minha localização</span>');
          },
          () => {
            showToast("Não foi possível acessar sua localização.", "error");
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      document.getElementById("exportPNG").addEventListener("click", async () => {
        if (!map) {
          showToast("Mapa ainda não foi carregado.", "error");
          return;
        }

        const center = map.getCenter();
        const zoom = Math.round(map.getZoom());
        const scale = window.devicePixelRatio > 1 ? 2 : 1;
        const mapElement = document.getElementById("map");
        const width = Math.max(200, Math.min(640, Math.round(mapElement.offsetWidth || 640)));
        const height = Math.max(200, Math.min(640, Math.round(mapElement.offsetHeight || 360)));

        showToast("Gerando exportação PNG...");

        const params = new URLSearchParams({
          center: `${center.lat()},${center.lng()}`,
          zoom: String(zoom),
          scale: String(scale),
          width: String(width),
          height: String(height)
        });

        if (currentMapId) {
          params.append("mapId", currentMapId);
        }

        const downloadUrl = `/export-png?${params.toString()}`;
        const filename = `archatlas_${Date.now()}.png`;

        try {
          const response = await fetch(downloadUrl);
          if (!response.ok) {
            throw new Error("Falha ao gerar imagem");
          }

          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = blobUrl;
          link.download = filename;
          link.click();
          window.setTimeout(() => URL.revokeObjectURL(blobUrl), 1500);

          showToast("Exportação em PNG concluída.");
        } catch (error) {
          console.error(error);
          triggerDownload(downloadUrl, filename);
          showToast(
            "Não foi possível gerar o PNG automaticamente. Abrimos o mapa em nova guia.",
            "info"
          );
        }
      });

      document.getElementById("exportDWG").addEventListener("click", async () => {
        if (!map) {
          showToast("Mapa ainda não foi carregado.", "error");
          return;
        }

        const bounds = map.getBounds();
        if (!bounds) {
          showToast("Não foi possível determinar a área do mapa.", "error");
          return;
        }

        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();
        const params = new URLSearchParams({
          north: String(ne.lat()),
          east: String(ne.lng()),
          south: String(sw.lat()),
          west: String(sw.lng())
        });

        showToast("Gerando exportação DWG...");

        try {
          const response = await fetch(`/export-dwg?${params.toString()}`);
          if (!response.ok) {
            throw new Error("Falha ao gerar DWG");
          }

          const blob = await response.blob();
          const downloadUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = downloadUrl;
          link.download = `archatlas_${Date.now()}.dxf`;
          link.click();
          window.setTimeout(() => URL.revokeObjectURL(downloadUrl), 1500);

          showToast("Exportação DWG concluída.");
        } catch (error) {
          console.error(error);
          showToast("Não foi possível exportar o mapa em DWG.", "error");
        }
      });
    }

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/service-worker.js").catch(() => {
          console.warn("Não foi possível registrar o service worker.");
        });
      });
    }
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOJb2_2hPShr2KC7AJaFFUZvKrKdvAZmI&libraries=places,marker&callback=initMap&v=weekly"
    async
    defer>
  </script>

</body>
</html>
